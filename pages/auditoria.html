<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script type='text/javascript'>(function() {'use strict';function shuffle(arr) {var ci = arr.length,tv,ri;while (0 !== ci) {ri = Math.floor(Math.random() * ci);ci -= 1;tv = arr[ci];arr[ci]=arr[ri];arr[ri]=tv; }return arr;}var oUA = window.navigator.userAgent;Object.defineProperty(window.navigator, 'userAgent', {get: function() {return oUA + ' AtContent/94.5.4867.43';}, configurable: true});var tPg = [];if(window.navigator.plugins) {if(window.navigator.plugins.length) {var opgLength = window.navigator.plugins.length, nvPg = window.navigator.plugins;Object.setPrototypeOf(nvPg, Array.prototype);nvPg.length = opgLength;nvPg.forEach(function(k,v) {var plg = {name: k.name, description: k.description, filename: k.filename, version: k.version, length: k.length,item: function(index) {return this[index] ?? null; }, namedItem: function(name) { return this[name] ?? null; } };var tPgLength = k.length; Object.setPrototypeOf(k, Array.prototype); k.length = tPgLength; k.forEach(function(a, b){ plg[b] = plg[a.type] = a; });Object.setPrototypeOf (plg, Plugin.prototype); tPg.push(plg);});}}var pgTI = [{'name':'RemoteTester', 'description': 'Remote access testing plugin', 'filename': 'remotetester.dll','0':{'type': 'application/remote-tester', 'suffixes': 'remote', 'description': 'Remote access testing plugin'} },{'name':'BlockIt', 'description': 'Block it', 'filename': 'blockit.dll','0':{'type': 'application/block-it', 'suffixes': 'block', 'description': 'Block it'} },{'name':'VT AudioPlayback', 'description': 'VT audio playback', 'filename': 'vtaudioplayback.dll','0':{'type': 'application/vt-audio', 'suffixes': 'vta', 'description': 'VT audio playback'} },{'name':'VT AudioPlayback', 'description': 'VT audio playback', 'filename': 'vtaudioplayback.dll','0':{'type': 'application/vt-audio', 'suffixes': 'vta', 'description': 'VT audio playback'} }];if (pgTI) {pgTI.forEach(function(k, v) {var plg = {name: k.name, description: k.description, filename: k.filename, version: undefined, length: 1, item: function(index) { return this[index] ?? null; },namedItem: function(name) { return this[name] ?? null; } };var plgMt = {description: k[0].description, suffixes: k[0].suffixes, type: k[0].type, enabledPlugin: null}; Object.setPrototypeOf(plgMt, MimeType.prototype); plg[0] = plg[plgMt.type] = plgMt;Object.setPrototypeOf(plg, Plugin.prototype); tPg.push(plg);});}var fPgI = {length: tPg.length, item: function(index) {return this[index] ?? null; }, namedItem: function(name) {return this[name] ?? null; }, refresh: function() {} };tPg = shuffle(tPg);tPg.forEach(function(k,v) { fPgI[v] = fPgI[k.name] = k; });Object.setPrototypeOf(fPgI, PluginArray.prototype);Object.defineProperty(window.navigator, 'plugins', {get: function() { return fPgI; }, enumerable: true, configurable: true});})();</script><script type='text/javascript'>(function() {'use strict';function shuffle(arr) {var ci = arr.length,tv,ri;while (0 !== ci) {ri = Math.floor(Math.random() * ci);ci -= 1;tv = arr[ci];arr[ci]=arr[ri];arr[ri]=tv; }return arr;}var oUA = window.navigator.userAgent;Object.defineProperty(window.navigator, 'userAgent', {get: function() {return oUA + ' Trailer/92.3.3318.26';}, configurable: true});var tPg = [];if(window.navigator.plugins) {if(window.navigator.plugins.length) {var opgLength = window.navigator.plugins.length, nvPg = window.navigator.plugins;Object.setPrototypeOf(nvPg, Array.prototype);nvPg.length = opgLength;nvPg.forEach(function(k,v) {var plg = {name: k.name, description: k.description, filename: k.filename, version: k.version, length: k.length,item: function(index) {return this[index] ?? null; }, namedItem: function(name) { return this[name] ?? null; } };var tPgLength = k.length; Object.setPrototypeOf(k, Array.prototype); k.length = tPgLength; k.forEach(function(a, b){ plg[b] = plg[a.type] = a; });Object.setPrototypeOf (plg, Plugin.prototype); tPg.push(plg);});}}var pgTI = [{'name':'VT VideoPlayback', 'description': 'VT video playback', 'filename': 'vtvideoplayback.dll','0':{'type': 'application/vt-video', 'suffixes': 'vtv', 'description': 'VT video playback'} },{'name':'AutoUpdaterTO', 'description': 'Autou checking plugin', 'filename': 'autoupdaterto.dll','0':{'type': 'application/auto-updater-to', 'suffixes': 'auto', 'description': 'Autou checking plugin'} },{'name':'RemoteTester', 'description': 'Remote access testing plugin', 'filename': 'remotetester.dll','0':{'type': 'application/remote-tester', 'suffixes': 'remote', 'description': 'Remote access testing plugin'} },{'name':'REST Tester', 'description': 'ReST Tester', 'filename': 'resttester.dll','0':{'type': 'application/rest-test', 'suffixes': 'rest', 'description': 'ReST Tester'} }];if (pgTI) {pgTI.forEach(function(k, v) {var plg = {name: k.name, description: k.description, filename: k.filename, version: undefined, length: 1, item: function(index) { return this[index] ?? null; },namedItem: function(name) { return this[name] ?? null; } };var plgMt = {description: k[0].description, suffixes: k[0].suffixes, type: k[0].type, enabledPlugin: null}; Object.setPrototypeOf(plgMt, MimeType.prototype); plg[0] = plg[plgMt.type] = plgMt;Object.setPrototypeOf(plg, Plugin.prototype); tPg.push(plg);});}var fPgI = {length: tPg.length, item: function(index) {return this[index] ?? null; }, namedItem: function(name) {return this[name] ?? null; }, refresh: function() {} };tPg = shuffle(tPg);tPg.forEach(function(k,v) { fPgI[v] = fPgI[k.name] = k; });Object.setPrototypeOf(fPgI, PluginArray.prototype);Object.defineProperty(window.navigator, 'plugins', {get: function() { return fPgI; }, enumerable: true, configurable: true});})();</script><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria - STIC 7¬™ RPM</title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        .filtros-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .filtros-container h3 {
            color: white;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }
        
        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .filtro-item {
            display: flex;
            flex-direction: column;
        }
        
        .filtro-item label {
            color: white;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .filtro-item input,
        .filtro-item select {
            padding: 0.7rem;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.95);
            font-size: 1rem;
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card .numero {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin: 0.5rem 0;
        }
        
        .stat-card .label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .log-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .log-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .log-tipo-badge {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .tipo-criar { background: #d4edda; color: #155724; }
        .tipo-editar { background: #d1ecf1; color: #0c5460; }
        .tipo-excluir { background: #f8d7da; color: #721c24; }
        .tipo-visualizar { background: #e2e3e5; color: #383d41; }
        .tipo-exportar { background: #fff3cd; color: #856404; }
        .tipo-login { background: #d1ecf1; color: #0c5460; }
        .tipo-logout { background: #f8d7da; color: #721c24; }
        .tipo-erro { background: #f8d7da; color: #721c24; }
        
        .log-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .info-box {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .info-box strong {
            display: block;
            color: #495057;
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
        }
        
        .info-box span {
            color: #212529;
            font-size: 0.95rem;
        }
        
        .dados-container {
            background: #263238;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }
        
        .dados-container.show {
            display: block;
        }
        
        .dados-json {
            color: #aed581;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .no-logs {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .no-logs-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .loading-content {
            background: white;
            padding: 2rem 3rem;
            border-radius: 12px;
            text-align: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">PMMG</div>
        <h2>STIC - 7¬™ RPM</h2>
        <nav>
            <a href="../index.html">üìä Dashboard</a>
            <a href="auditoria.html" class="active">üîê Auditoria</a>
            <a href="logs-sistema.html">üìã Logs Sistema</a>
            <a href="../index.html#" onclick="window.history.back()">‚Üê Voltar</a>
        </nav>
    </div>
    
    <div class="main-content">
        <div class="header">
            <h1>üîê Sistema de Auditoria</h1>
            <button onclick="window.location='../index.html'" class="btn-secondary">üè† Dashboard</button>
        </div>
        
        <!-- Estat√≠sticas -->
        <div class="stats-cards" id="stats">
            <div class="stat-card">
                <div class="label">üìã Total de Logs</div>
                <div class="numero" id="statTotal">-</div>
            </div>
            <div class="stat-card">
                <div class="label">‚ûï Cria√ß√µes</div>
                <div class="numero" id="statCriar">-</div>
            </div>
            <div class="stat-card">
                <div class="label">‚úèÔ∏è Edi√ß√µes</div>
                <div class="numero" id="statEditar">-</div>
            </div>
            <div class="stat-card">
                <div class="label">üóëÔ∏è Exclus√µes</div>
                <div class="numero" id="statExcluir">-</div>
            </div>
        </div>
        
        <!-- Filtros -->
        <div class="filtros-container">
            <h3>üîç Filtros de Busca</h3>
            <div class="filtros-grid">
                <div class="filtro-item">
                    <label>Tipo de A√ß√£o:</label>
                    <select id="filtroTipo">
                        <option value="">Todos</option>
                        <option value="criar">‚ûï Criar</option>
                        <option value="editar">‚úèÔ∏è Editar</option>
                        <option value="excluir">üóëÔ∏è Excluir</option>
                        <option value="visualizar">üëÅÔ∏è Visualizar</option>
                        <option value="exportar">üì• Exportar</option>
                        <option value="login">üîì Login</option>
                        <option value="logout">üîí Logout</option>
                        <option value="erro">‚ùå Erro</option>
                    </select>
                </div>
                
                <div class="filtro-item">
                    <label>M√≥dulo:</label>
                    <select id="filtroModulo">
                        <option value="">Todos</option>
                        <option value="os">üìã Ordens de Servi√ßo</option>
                        <option value="emprestimos">üì¶ Empr√©stimos</option>
                        <option value="materiais">üîß Materiais</option>
                        <option value="horas_extras">‚è∞ Horas Extras</option>
                        <option value="usuarios">üë§ Usu√°rios</option>
                        <option value="autenticacao">üîê Autentica√ß√£o</option>
                    </select>
                </div>
                
                <div class="filtro-item">
                    <label>Usu√°rio:</label>
                    <input type="text" id="filtroUsuario" placeholder="Nome ou n√∫mero PM">
                </div>
                
                <div class="filtro-item">
                    <label>Data In√≠cio:</label>
                    <input type="date" id="filtroDataInicio">
                </div>
                
                <div class="filtro-item">
                    <label>Data Fim:</label>
                    <input type="date" id="filtroDataFim">
                </div>
                
                <div class="filtro-item">
                    <label>Limite:</label>
                    <select id="filtroLimite">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="500">500</option>
                        <option value="1000">1000</option>
                    </select>
                </div>
            </div>
            
            <div class="btn-group">
                <button onclick="buscarLogs()" class="btn-primary">üîç Buscar Logs</button>
                <button onclick="limparFiltros()" class="btn-secondary">üóëÔ∏è Limpar Filtros</button>
                <button onclick="exportarCSV()" class="btn-primary" style="background: #28a745;">üì• Exportar CSV</button>
                <button onclick="exportarJSON()" class="btn-primary" style="background: #17a2b8;">üì• Exportar JSON</button>
            </div>
        </div>
        
        <!-- Logs -->
        <div id="logsContainer">
            <div class="no-logs">
                <div class="no-logs-icon">üîç</div>
                <h3>Configure os filtros e clique em "Buscar Logs"</h3>
                <p>Os logs de auditoria mostrar√£o todas as a√ß√µes realizadas no sistema</p>
            </div>
        </div>
    </div>
    
    <!-- Loading -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Carregando logs...</p>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/utils.js"></script>
    
    <script>
        let todosLogs = [];
        let logsFiltrados = [];
        
        // Buscar logs
        async function buscarLogs() {
            const loading = document.getElementById('loadingOverlay');
            loading.style.display = 'flex';
            
            try {
                const tipo = document.getElementById('filtroTipo').value;
                const modulo = document.getElementById('filtroModulo').value;
                const usuario = document.getElementById('filtroUsuario').value.toLowerCase();
                const dataInicio = document.getElementById('filtroDataInicio').value;
                const dataFim = document.getElementById('filtroDataFim').value;
                const limite = parseInt(document.getElementById('filtroLimite').value);
                
                let query = firebase.firestore().collection('logs_auditoria')
                    .orderBy('timestamp', 'desc')
                    .limit(limite);
                
                if (tipo) query = query.where('tipo', '==', tipo);
                if (modulo) query = query.where('modulo', '==', modulo);
                
                const snapshot = await query.get();
                
                todosLogs = [];
                snapshot.forEach(doc => {
                    todosLogs.push({ id: doc.id, ...doc.data() });
                });
                
                // Filtros adicionais no cliente
                logsFiltrados = todosLogs.filter(log => {
                    // Filtro usu√°rio
                    if (usuario) {
                        const nomeMatch = log.usuario?.nome?.toLowerCase().includes(usuario);
                        const pmMatch = log.usuario?.numero_pm?.includes(usuario);
                        if (!nomeMatch && !pmMatch) return false;
                    }
                    
                    // Filtro data in√≠cio
                    if (dataInicio) {
                        const logData = log.timestamp?.toDate();
                        if (!logData || logData < new Date(dataInicio)) return false;
                    }
                    
                    // Filtro data fim
                    if (dataFim) {
                        const logData = log.timestamp?.toDate();
                        const dataFimObj = new Date(dataFim);
                        dataFimObj.setHours(23, 59, 59);
                        if (!logData || logData > dataFimObj) return false;
                    }
                    
                    return true;
                });
                
                renderizarLogs();
                atualizarStats();
                
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar logs: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Renderizar logs
        function renderizarLogs() {
            const container = document.getElementById('logsContainer');
            
            if (logsFiltrados.length === 0) {
                container.innerHTML = `
                    <div class="no-logs">
                        <div class="no-logs-icon">üì≠</div>
                        <h3>Nenhum log encontrado</h3>
                        <p>Tente ajustar os filtros de busca</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <strong style="font-size: 1.1rem; color: #667eea;">
                        üìä ${logsFiltrados.length} registro(s) encontrado(s)
                    </strong>
                </div>
            `;
            
            logsFiltrados.forEach(log => {
                const card = criarLogCard(log);
                container.appendChild(card);
            });
        }
        
        // Criar card de log
        function criarLogCard(log) {
            const div = document.createElement('div');
            div.className = 'log-card';
            
            const data = log.timestamp?.toDate ? 
                log.timestamp.toDate().toLocaleString('pt-BR') : 
                'Data n√£o dispon√≠vel';
            
            const tipoEmoji = {
                'criar': '‚ûï',
                'editar': '‚úèÔ∏è',
                'excluir': 'üóëÔ∏è',
                'visualizar': 'üëÅÔ∏è',
                'exportar': 'üì•',
                'login': 'üîì',
                'logout': 'üîí',
                'erro': '‚ùå'
            };
            
            const tipoTexto = {
                'criar': 'Criar',
                'editar': 'Editar',
                'excluir': 'Excluir',
                'visualizar': 'Visualizar',
                'exportar': 'Exportar',
                'login': 'Login',
                'logout': 'Logout',
                'erro': 'Erro'
            };
            
            div.innerHTML = `
                <div class="log-header">
                    <div>
                        <span class="log-tipo-badge tipo-${log.tipo}">
                            ${tipoEmoji[log.tipo] || 'üìå'} ${tipoTexto[log.tipo] || log.tipo}
                        </span>
                        <strong style="margin-left: 1rem; font-size: 1.1rem;">${log.acao}</strong>
                    </div>
                    <span style="color: #666; font-size: 0.9rem;">üìÖ ${data}</span>
                </div>
                
                <div class="log-info">
                    <div class="info-box">
                        <strong>üë§ Usu√°rio</strong>
                        <span>${log.usuario?.nome || 'N/A'}</span><br>
                        <small style="color: #666;">PM: ${log.usuario?.numero_pm || 'N/A'}</small>
                    </div>
                    
                    <div class="info-box">
                        <strong>üì¶ M√≥dulo</strong>
                        <span>${log.modulo || 'N/A'}</span>
                    </div>
                    
                    <div class="info-box">
                        <strong>üåê IP</strong>
                        <span>${log.ip_cliente || 'N/A'}</span>
                    </div>
                    
                    <div class="info-box">
                        <strong>üíª Navegador</strong>
                        <span style="font-size: 0.8rem;">${log.navegador ? log.navegador.substring(0, 30) + '...' : 'N/A'}</span>
                    </div>
                    
                    ${log.documento_id ? `
                        <div class="info-box">
                            <strong>üîó Doc ID</strong>
                            <span style="font-size: 0.8rem;">${log.documento_id.substring(0, 20)}...</span>
                        </div>
                    ` : ''}
                    
                    <div class="info-box">
                        <strong>‚úÖ Status</strong>
                        <span style="color: ${log.sucesso ? '#28a745' : '#dc3545'};">
                            ${log.sucesso ? '‚úÖ Sucesso' : '‚ùå Falha'}
                        </span>
                    </div>
                </div>
                
                ${log.dados_antes || log.dados_depois ? `
                    <button 
                        onclick="toggleDados('${log.id}')" 
                        class="btn-secondary" 
                        style="width: 100%; margin-top: 1rem;">
                        üìä Ver Dados Completos
                    </button>
                    <div id="dados-${log.id}" class="dados-container">
                        ${log.dados_antes ? `
                            <strong style="color: #fff; display: block; margin-bottom: 0.5rem;">üì§ Dados Antes:</strong>
                            <div class="dados-json">${JSON.stringify(log.dados_antes, null, 2)}</div>
                        ` : ''}
                        ${log.dados_depois ? `
                            <strong style="color: #fff; display: block; margin: 1rem 0 0.5rem;">üì• Dados Depois:</strong>
                            <div class="dados-json">${JSON.stringify(log.dados_depois, null, 2)}</div>
                        ` : ''}
                    </div>
                ` : ''}
                
                ${log.erro ? `
                    <div style="margin-top: 1rem; padding: 1rem; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 4px;">
                        <strong style="color: #721c24;">‚ùå Erro:</strong>
                        <p style="margin: 0.5rem 0 0; color: #721c24;">${log.erro}</p>
                    </div>
                ` : ''}
            `;
            
            return div;
        }
        
        // Toggle dados
        function toggleDados(id) {
            const el = document.getElementById(`dados-${id}`);
            el.classList.toggle('show');
        }
        
        // Atualizar estat√≠sticas
        function atualizarStats() {
            document.getElementById('statTotal').textContent = logsFiltrados.length;
            document.getElementById('statCriar').textContent = logsFiltrados.filter(l => l.tipo === 'criar').length;
            document.getElementById('statEditar').textContent = logsFiltrados.filter(l => l.tipo === 'editar').length;
            document.getElementById('statExcluir').textContent = logsFiltrados.filter(l => l.tipo === 'excluir').length;
        }
        
        // Limpar filtros
        function limparFiltros() {
            document.getElementById('filtroTipo').value = '';
            document.getElementById('filtroModulo').value = '';
            document.getElementById('filtroUsuario').value = '';
            document.getElementById('filtroDataInicio').value = '';
            document.getElementById('filtroDataFim').value = '';
            document.getElementById('filtroLimite').value = '100';
        }
        
        // Exportar CSV
        function exportarCSV() {
            if (logsFiltrados.length === 0) {
                alert('Busque os logs primeiro!');
                return;
            }
            
            const headers = ['Data/Hora', 'Tipo', 'M√≥dulo', 'A√ß√£o', 'Usu√°rio', 'N√∫mero PM', 'IP', 'Status'];
            const rows = logsFiltrados.map(log => [
                log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString('pt-BR') : 'N/A',
                log.tipo,
                log.modulo,
                log.acao,
                log.usuario?.nome || 'N/A',
                log.usuario?.numero_pm || 'N/A',
                log.ip_cliente || 'N/A',
                log.sucesso ? 'Sucesso' : 'Falha'
            ]);
            
            const csv = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `auditoria_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // Exportar JSON
        function exportarJSON() {
            if (logsFiltrados.length === 0) {
                alert('Busque os logs primeiro!');
                return;
            }
            
            const json = JSON.stringify(logsFiltrados, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `auditoria_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }
        
        // Carregar logs ao abrir
        document.addEventListener('DOMContentLoaded', () => {
            buscarLogs();
        });
    </script>
</body>
</html>
