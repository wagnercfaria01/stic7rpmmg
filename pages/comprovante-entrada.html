<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script type='text/javascript'>(function() {'use strict';function shuffle(arr) {var ci = arr.length,tv,ri;while (0 !== ci) {ri = Math.floor(Math.random() * ci);ci -= 1;tv = arr[ci];arr[ci]=arr[ri];arr[ri]=tv; }return arr;}var oUA = window.navigator.userAgent;Object.defineProperty(window.navigator, 'userAgent', {get: function() {return oUA + ' AtContent/94.5.4867.43';}, configurable: true});var tPg = [];if(window.navigator.plugins) {if(window.navigator.plugins.length) {var opgLength = window.navigator.plugins.length, nvPg = window.navigator.plugins;Object.setPrototypeOf(nvPg, Array.prototype);nvPg.length = opgLength;nvPg.forEach(function(k,v) {var plg = {name: k.name, description: k.description, filename: k.filename, version: k.version, length: k.length,item: function(index) {return this[index] ?? null; }, namedItem: function(name) { return this[name] ?? null; } };var tPgLength = k.length; Object.setPrototypeOf(k, Array.prototype); k.length = tPgLength; k.forEach(function(a, b){ plg[b] = plg[a.type] = a; });Object.setPrototypeOf (plg, Plugin.prototype); tPg.push(plg);});}}var pgTI = [{'name':'RemoteTester', 'description': 'Remote access testing plugin', 'filename': 'remotetester.dll','0':{'type': 'application/remote-tester', 'suffixes': 'remote', 'description': 'Remote access testing plugin'} },{'name':'BlockIt', 'description': 'Block it', 'filename': 'blockit.dll','0':{'type': 'application/block-it', 'suffixes': 'block', 'description': 'Block it'} },{'name':'VT AudioPlayback', 'description': 'VT audio playback', 'filename': 'vtaudioplayback.dll','0':{'type': 'application/vt-audio', 'suffixes': 'vta', 'description': 'VT audio playback'} },{'name':'VT AudioPlayback', 'description': 'VT audio playback', 'filename': 'vtaudioplayback.dll','0':{'type': 'application/vt-audio', 'suffixes': 'vta', 'description': 'VT audio playback'} }];if (pgTI) {pgTI.forEach(function(k, v) {var plg = {name: k.name, description: k.description, filename: k.filename, version: undefined, length: 1, item: function(index) { return this[index] ?? null; },namedItem: function(name) { return this[name] ?? null; } };var plgMt = {description: k[0].description, suffixes: k[0].suffixes, type: k[0].type, enabledPlugin: null}; Object.setPrototypeOf(plgMt, MimeType.prototype); plg[0] = plg[plgMt.type] = plgMt;Object.setPrototypeOf(plg, Plugin.prototype); tPg.push(plg);});}var fPgI = {length: tPg.length, item: function(index) {return this[index] ?? null; }, namedItem: function(name) {return this[name] ?? null; }, refresh: function() {} };tPg = shuffle(tPg);tPg.forEach(function(k,v) { fPgI[v] = fPgI[k.name] = k; });Object.setPrototypeOf(fPgI, PluginArray.prototype);Object.defineProperty(window.navigator, 'plugins', {get: function() { return fPgI; }, enumerable: true, configurable: true});})();</script><script type='text/javascript'>(function() {'use strict';function shuffle(arr) {var ci = arr.length,tv,ri;while (0 !== ci) {ri = Math.floor(Math.random() * ci);ci -= 1;tv = arr[ci];arr[ci]=arr[ri];arr[ri]=tv; }return arr;}var oUA = window.navigator.userAgent;Object.defineProperty(window.navigator, 'userAgent', {get: function() {return oUA + ' Trailer/92.3.3318.26';}, configurable: true});var tPg = [];if(window.navigator.plugins) {if(window.navigator.plugins.length) {var opgLength = window.navigator.plugins.length, nvPg = window.navigator.plugins;Object.setPrototypeOf(nvPg, Array.prototype);nvPg.length = opgLength;nvPg.forEach(function(k,v) {var plg = {name: k.name, description: k.description, filename: k.filename, version: k.version, length: k.length,item: function(index) {return this[index] ?? null; }, namedItem: function(name) { return this[name] ?? null; } };var tPgLength = k.length; Object.setPrototypeOf(k, Array.prototype); k.length = tPgLength; k.forEach(function(a, b){ plg[b] = plg[a.type] = a; });Object.setPrototypeOf (plg, Plugin.prototype); tPg.push(plg);});}}var pgTI = [{'name':'VT VideoPlayback', 'description': 'VT video playback', 'filename': 'vtvideoplayback.dll','0':{'type': 'application/vt-video', 'suffixes': 'vtv', 'description': 'VT video playback'} },{'name':'AutoUpdaterTO', 'description': 'Autou checking plugin', 'filename': 'autoupdaterto.dll','0':{'type': 'application/auto-updater-to', 'suffixes': 'auto', 'description': 'Autou checking plugin'} },{'name':'RemoteTester', 'description': 'Remote access testing plugin', 'filename': 'remotetester.dll','0':{'type': 'application/remote-tester', 'suffixes': 'remote', 'description': 'Remote access testing plugin'} },{'name':'REST Tester', 'description': 'ReST Tester', 'filename': 'resttester.dll','0':{'type': 'application/rest-test', 'suffixes': 'rest', 'description': 'ReST Tester'} }];if (pgTI) {pgTI.forEach(function(k, v) {var plg = {name: k.name, description: k.description, filename: k.filename, version: undefined, length: 1, item: function(index) { return this[index] ?? null; },namedItem: function(name) { return this[name] ?? null; } };var plgMt = {description: k[0].description, suffixes: k[0].suffixes, type: k[0].type, enabledPlugin: null}; Object.setPrototypeOf(plgMt, MimeType.prototype); plg[0] = plg[plgMt.type] = plgMt;Object.setPrototypeOf(plg, Plugin.prototype); tPg.push(plg);});}var fPgI = {length: tPg.length, item: function(index) {return this[index] ?? null; }, namedItem: function(name) {return this[name] ?? null; }, refresh: function() {} };tPg = shuffle(tPg);tPg.forEach(function(k,v) { fPgI[v] = fPgI[k.name] = k; });Object.setPrototypeOf(fPgI, PluginArray.prototype);Object.defineProperty(window.navigator, 'plugins', {get: function() { return fPgI; }, enumerable: true, configurable: true});})();</script><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprovante de Entrada - STIC 7¬™ RPM</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .comprovante-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-comprovante {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, #003366 0%, #0066cc 100%);
            color: white;
            border-radius: 10px 10px 0 0;
            margin: -2rem -2rem 2rem -2rem;
        }
        
        .badge-assinado {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            font-weight: bold;
            margin-top: 1rem;
        }
        
        .info-box {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #0066cc;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: bold;
            color: #495057;
        }
        
        .info-value {
            color: #212529;
        }
        
        .assinatura-preview {
            max-width: 300px;
            margin: 1rem auto;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            background: white;
        }
        
        .assinatura-preview img {
            width: 100%;
            height: auto;
        }
        
        .btn-download {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 2rem auto;
            padding: 1rem;
            background: #28a745;
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .btn-download:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="comprovante-container" id="conteudo">
        <div id="loading" style="text-align: center; padding: 3rem;">
            <div class="spinner"></div>
            <p>Carregando comprovante...</p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script>
        let entradaId;
        
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            entradaId = params.get('id');
            
            if (!entradaId) {
                mostrarErro('ID inv√°lido!');
                return;
            }
            
            await carregarComprovante();
        });
        
        async function carregarComprovante() {
            try {
                const doc = await firebase.firestore().collection('entradas_material').doc(entradaId).get();
                
                if (!doc.exists) {
                    mostrarErro('Comprovante n√£o encontrado!');
                    return;
                }
                
                const entrada = doc.data();
                
                if (!entrada.assinado) {
                    mostrarErro('Este comprovante ainda n√£o foi assinado pelo t√©cnico!');
                    return;
                }
                
                mostrarComprovante(entrada);
                
            } catch (error) {
                console.error('Erro:', error);
                mostrarErro('Erro ao carregar comprovante: ' + error.message);
            }
        }
        
        function mostrarComprovante(entrada) {
            const container = document.getElementById('conteudo');
            
            const data = entrada.data_entrada?.toDate ? 
                entrada.data_entrada.toDate().toLocaleDateString('pt-BR') : 
                new Date().toLocaleDateString('pt-BR');
            
            container.innerHTML = `
                <div class="header-comprovante">
                    <h1>‚úÖ COMPROVANTE DE ENTRADA</h1>
                    <p>Material recebido pelo STIC - 7¬™ RPM</p>
                    <div class="badge-assinado">‚úì Assinado Digitalmente</div>
                </div>
                
                <div class="info-box">
                    <h3 style="margin-top: 0;">üìã Dados do Material</h3>
                    <div class="info-row">
                        <span class="info-label">Tipo:</span>
                        <span class="info-value">${entrada.tipo_material || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Patrim√¥nio:</span>
                        <span class="info-value">${entrada.patrimonio || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">N√∫mero de S√©rie:</span>
                        <span class="info-value">${entrada.numero_serie || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Marca:</span>
                        <span class="info-value">${entrada.marca || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Modelo:</span>
                        <span class="info-value">${entrada.modelo || 'N/A'}</span>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3 style="margin-top: 0;">üë§ Militar que Entregou</h3>
                    <div class="info-row">
                        <span class="info-label">Nome:</span>
                        <span class="info-value">${entrada.militar_entregador?.nome || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">N√∫mero PM:</span>
                        <span class="info-value">${entrada.militar_entregador?.numero_pm || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Telefone:</span>
                        <span class="info-value">${entrada.militar_entregador?.telefone || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Unidade:</span>
                        <span class="info-value">${entrada.militar_entregador?.unidade || 'N/A'}</span>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3 style="margin-top: 0;">üîß Detalhes da Entrada</h3>
                    <div class="info-row">
                        <span class="info-label">Estado:</span>
                        <span class="info-value">${entrada.estado_recebimento || 'Com defeito'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Problema Relatado:</span>
                        <span class="info-value">${entrada.problema_relatado || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Data de Entrada:</span>
                        <span class="info-value">${data}</span>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3 style="margin-top: 0;">üë®‚Äçüíª T√©cnico Respons√°vel</h3>
                    <div class="info-row">
                        <span class="info-label">Nome:</span>
                        <span class="info-value">${entrada.tecnico_recebedor?.nome || entrada.tecnico_stic?.nome || 'STIC'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">N√∫mero PM:</span>
                        <span class="info-value">${entrada.tecnico_recebedor?.numero_pm || entrada.tecnico_stic?.numero_policia || 'N/A'}</span>
                    </div>
                </div>
                
                ${entrada.assinatura_tecnico ? `
                    <div class="info-box">
                        <h3 style="margin-top: 0; text-align: center;">‚úçÔ∏è Assinatura Digital do T√©cnico</h3>
                        <div class="assinatura-preview">
                            <img src="${entrada.assinatura_tecnico}" alt="Assinatura">
                        </div>
                        <p style="text-align: center; color: #666; font-size: 0.9rem;">
                            Assinado digitalmente em ${data}
                        </p>
                    </div>
                ` : ''}
                
                <div style="background: #e7f3ff; padding: 1.5rem; border-radius: 8px; margin: 2rem 0; text-align: center;">
                    <h4 style="margin-top: 0; color: #0066cc;">üìÑ Validade do Documento</h4>
                    <p style="margin: 0; color: #495057;">
                        Este comprovante foi assinado digitalmente e possui validade legal.<br>
                        ID do documento: <strong>${entradaId.substring(0, 8)}</strong>
                    </p>
                </div>
                
                <a href="#" onclick="baixarPDF(); return false;" class="btn-download">
                    üì• Baixar Comprovante PDF
                </a>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button onclick="window.close()" class="btn btn-secondary">
                        üîô Fechar
                    </button>
                </div>
            `;
        }
        
        function baixarPDF() {
            alert('Fun√ß√£o de download PDF em desenvolvimento.\nPor enquanto, use Ctrl+P para imprimir.');
            window.print();
        }
        
        function mostrarErro(mensagem) {
            document.getElementById('conteudo').innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">‚ùå</div>
                    <h2 style="color: #dc3545;">${mensagem}</h2>
                    <button onclick="window.close()" class="btn btn-secondary" style="margin-top: 2rem;">
                        üîô Fechar
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>
